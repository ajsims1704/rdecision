---
title: "Sumatriptan versus caffeine for migraine"
subtitle: "A decision tree example"
author: "Andrew J. Sims"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Sumatriptan versus caffeine for migraine}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
references:
- id: briggs:2002a
  type: book
  author:
    - family: Briggs
      given: Andrew
    - family: Claxton
      given: Karl
    - family: Sculpher
      given: Mark
  title: "Decision modelling for health economic evaluation"
  publisher: "Oxford University Press"
  publisher-place: "Oxford, UK"
  isbn: 978-0-19-852662-9
  issued:
    - year: 2006
- id: evans:1997a
  type: article
  author:
    - given: Kenneth W.
      family: Evans
    - given: John A.
      family: Boan
    - given: John L.
      family: Evans
    - given: Ashfaq
      family: Shuaib
  title: "Economic evaluation of oral Sumatriptan compared with oral Caffeine/Ergotamine for migraine"
  container-title: "Pharmacoeconomics"
  issued:
    - year: 1997
  volume: "12"
  issue: 5
  page: 565-577
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=F}
library(rdecision)
```

# Introduction
This vignette is an example of modelling a decision tree using the `rdecision`
package. It is based on the example given by Briggs [-@briggs:2002a, Box 2.3] 
which itself is based on a decision tree which compared oral Sumatriptan versus
oral caffeine/Ergotamine for migraine [@evans:1997a].

# Creating the model
The following code constructs the decision tree, node by node. In the
formulation used by `rdecision`, each node is a potentially recursive
structure which is allowed to have zero or more child nodes; any child
nodes must have already been declared before their parent node is declared.
This implies that a tree should be constructed from right to left, starting
with leaf nodes which have no children (leaf nodes are synonymous with
pathways in Briggs' terminology). The final node to be constructed 
is the left-most decision node in the model.


```{r echo=T}
# Sumatriptan branch
leaf.a <- LeafNode$new("A", utility=1.0)
leaf.b <- LeafNode$new("B", utility=0.9)
leaf.c <- LeafNode$new("C", utility=-0.3)
leaf.d <- LeafNode$new("D", utility=0.1)
leaf.e <- LeafNode$new("E", utility=-0.3)

c.8 <- ChanceNode$new(
  p = list(0.998, 0.002),
  children = list(leaf.d, leaf.e),
  edgelabels = list("Relief", "Hospitalization"),
  costs = list(0, 1093.0)
)

c.4 <- ChanceNode$new(
  p = list(0.594, 0.406),
  children = list(leaf.a, leaf.b),
  edgelabels = list("No recurrence", "Recurrence relieved with 2nd dose"),
  costs = list(0, 16.10)
)

c.5 <- ChanceNode$new(
  p = list(0.920, 0.080),
  children = list(leaf.c, c.8),
  edgelabels = list("Endures attack", "ER"),
  costs = list(0, 63.16)
)

c.2 <- ChanceNode$new(
  p = list(0.558, 0.442),
  children = list(c.4, c.5),
  edgelabels = list("Relief", "No relief"),
  costs = list(0, 0)
)

# Caffeine/Ergotamine branch
leaf.f <- LeafNode$new("F", utility=1.0)
leaf.g <- LeafNode$new("G", utility=0.9)
leaf.h <- LeafNode$new("H", utility=-0.3)
leaf.i <- LeafNode$new("I", utility=0.1)
leaf.j <- LeafNode$new("J", utility=-0.3)

c.9 <- ChanceNode$new(
  p = list(0.998, 0.002),
  children = list(leaf.i, leaf.j),
  edgelabels = list("Relief", "Hospitalization"),
  costs = list(0, 1093.0)
)

c.6 <- ChanceNode$new(
  p = list(0.703, 0.297),
  children = list(leaf.f, leaf.g),
  edgelabels = list("No recurrence", "Recurrence relieved with 2nd dose"),
  costs = list(0, 1.32)
)

c.7 <- ChanceNode$new(
  p = list(0.920, 0.080),
  children = list(leaf.h, c.9),
  edgelabels = list("Endures attack", "ER"),
  costs = list(0, 63.13)
)

c.3 <- ChanceNode$new(
  p = list(0.379, 0.621),
  children = list(c.6, c.7),
  edgelabels = list("Relief", "No relief"),
  costs = list(0, 0)
)

# decision node
d.1 <- DecisionNode$new(
  children = list(c.2, c.3),
  edgelabels = list("Sumatriptan", "Caffeine/Ergotamine"),
  costs = list(16.10, 1.32)
)

```

# Running the model
The following code runs a single model scenario, using low-level
functions to evaluate each pathway and decision option. The
`path.apply` function applies a user-provided function to each
node of every root-to-leaf path in the model. In the Sumatriptan
model there are eight possible root-to-leaf paths, each of which
begins with the decision node and ends with a leaf node. For example,
pathway A involves a traversal of nodes `d.1`, `c.2`, `c.4` and
`leaf.a`. 

The argument to the function required by `path.apply` is simply an 
ordered list of nodes. The main challenge in computing, for example,
the probability of following the path is to work out which branch of
each chance node is linked to the next child node. For example when
traversing the list of nodes for pathway A, at chance node `c.4` some
effort is needed to establish which branch and p-value (0.594) leads
to leaf A. For this reason several functions suitable for use with
`path.apply` are provided by `rdecision`. The functions provided include

* `pathway.name` which returns the pathway name defined by its final
   leaf node;
* `pathway.choice` which returns the choice associated with the first
   decision node in the pathway;
* `pathway.probability` which returns the product of probabilities
   associated with the pathway;
* `pathway.cost` which returns the summed cost of traversing each 
   node in the pathway.
* `pathway.utility` which returns the utility associated with the final
   leaf node of each pathway.

The following code extracts and calculates various features associated
with each root-to-leaf node traversal, and puts them into a table.

```{r echo=T}
RES <- data.frame(
  'Choice' = unlist(path.apply(d.1, FUN=pathway.choice)),
  'Pathway' = unlist(path.apply(d.1, FUN=pathway.name)),
  'Probability' = unlist(path.apply(d.1, FUN=pathway.probability)),
  'Cost' = unlist(path.apply(d.1, FUN=pathway.cost)),
  'ExpectedCost' = NA,
  'Utility' = unlist(path.apply(d.1, FUN=pathway.utility)),
  'ExpectedUtility' = NA
)
RES$ExpectedCost <- round(RES$Probability*RES$Cost,2)
RES$ExpectedUtility <- round(RES$Probability*RES$Utility,4)
```

# Model results
The results of the scenario model, using the code from the previous section,
yields the following result:
```{r echo=F}
knitr::kable(RES)
```

There are, as expected, eight root-to-leaf pathways, which `path.apply` has 
worked out itself from the model structure. The total probability, expected
cost and expected utility for each choice can be calculated from the table
as follows:

```{r echo=T}
SUM <- aggregate(
  RES[,c('Probability', 'ExpectedCost', 'ExpectedUtility')],
  by = list(RES$Choice),
  FUN = sum
)
names(SUM) <- c('Choice', 'Probability', 'Expected Cost', 'Expected Utility')
```
which gives the following result, which is consistent with the result reported by
Evans *et al* [-@evans:1997a].

```{r echo=F}
knitr::kable(SUM)
```

```{r echo=F}
rm(RES, SUM)
```

# References

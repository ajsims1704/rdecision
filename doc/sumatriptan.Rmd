---
title: "Sumatriptan versus caffeine for migraine"
subtitle: "A decision tree example"
author: "Andrew J. Sims"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Sumatriptan versus caffeine for migraine}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
references:
- id: briggs:2002a
  type: book
  author:
    - family: Briggs
      given: Andrew
    - family: Claxton
      given: Karl
    - family: Sculpher
      given: Mark
  title: "Decision modelling for health economic evaluation"
  publisher: "Oxford University Press"
  publisher-place: "Oxford, UK"
  isbn: 978-0-19-852662-9
  issued:
    - year: 2006
- id: evans:1997a
  type: article
  author:
    - given: Kenneth W.
      family: Evans
    - given: John A.
      family: Boan
    - given: John L.
      family: Evans
    - given: Ashfaq
      family: Shuaib
  title: "Economic evaluation of oral Sumatriptan compared with oral Caffeine/Ergotamine for migraine"
  container-title: "Pharmacoeconomics"
  issued:
    - year: 1997
  volume: "12"
  issue: 5
  page: 565-577
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=F}
library(rdecision)
```

# Introduction
This vignette is an example of modelling a decision tree using the `rdecision`
package. It is based on the example given by Briggs [-@briggs:2002a, Box 2.3] 
which itself is based on a decision tree which compared oral Sumatriptan versus
oral caffeine/Ergotamine for migraine [@evans:1997a].

# Creating the model
The following code constructs the decision tree, node by node. In the
formulation used by `rdecision`, each node is a potentially recursive
structure which is allowed to have zero or more child nodes; any child
nodes must have already been declared before their parent node is declared.
This implies that a tree should be constructed from right to left, starting
with leaf nodes which have no children (leaf nodes are synonymous with
pathways in Briggs' terminology). The final node to be constructed 
is the left-most decision node in the model.

```{r echo=T}
# Sumatriptan branch
leaf.a <- LeafNode$new("A", utility=1.0)
leaf.b <- LeafNode$new("B", utility=0.9)
leaf.c <- LeafNode$new("C", utility=-0.3)
leaf.d <- LeafNode$new("D", utility=0.1)
leaf.e <- LeafNode$new("E", utility=-0.3)

c.8 <- ChanceNode$new(
  p = list(0.998, 0.002),
  children = list(leaf.d, leaf.e),
  edgelabels = list("Relief", "Hospitalization"),
  costs = list(0, 1093.0)
)

c.4 <- ChanceNode$new(
  p = list(0.594, 0.406),
  children = list(leaf.a, leaf.b),
  edgelabels = list("No recurrence", "Recurrence relieved with 2nd dose"),
  costs = list(0, 16.10)
)

c.5 <- ChanceNode$new(
  p = list(0.920, 0.080),
  children = list(leaf.c, c.8),
  edgelabels = list("Endures attack", "ER"),
  costs = list(0, 63.16)
)

c.2 <- ChanceNode$new(
  p = list(0.558, 0.442),
  children = list(c.4, c.5),
  edgelabels = list("Relief", "No relief"),
  costs = list(0, 0)
)

# Caffeine/Ergotamine branch
leaf.f <- LeafNode$new("F", utility=1.0)
leaf.g <- LeafNode$new("G", utility=0.9)
leaf.h <- LeafNode$new("H", utility=-0.3)
leaf.i <- LeafNode$new("I", utility=0.1)
leaf.j <- LeafNode$new("J", utility=-0.3)

c.9 <- ChanceNode$new(
  p = list(0.998, 0.002),
  children = list(leaf.i, leaf.j),
  edgelabels = list("Relief", "Hospitalization"),
  costs = list(0, 1093.0)
)

c.6 <- ChanceNode$new(
  p = list(0.703, 0.297),
  children = list(leaf.f, leaf.g),
  edgelabels = list("No recurrence", "Recurrence relieved with 2nd dose"),
  costs = list(0, 1.32)
)

c.7 <- ChanceNode$new(
  p = list(0.920, 0.080),
  children = list(leaf.h, c.9),
  edgelabels = list("Endures attack", "ER"),
  costs = list(0, 63.13)
)

c.3 <- ChanceNode$new(
  p = list(0.379, 0.621),
  children = list(c.6, c.7),
  edgelabels = list("Relief", "No relief"),
  costs = list(0, 0)
)

# decision node
d.1 <- DecisionNode$new(
  children = list(c.2, c.3),
  edgelabels = list("Sumatriptan", "Caffeine/Ergotamine"),
  costs = list(16.10, 1.32)
)
```

# Running the model
The method `evaluatePathways` of decision nodes computes
the probability, cost and utility of traversing each root-to-leaf path
in the model. In the Sumatriptan model there are eight such paths, each 
of which begins with the decision node and ends with a leaf node. For example,
pathway A involves a traversal of nodes `d.1`, `c.2`, `c.4` and
`leaf.a`. 

# Model results
The results of the scenario model, using the code from the previous sections,
yields the following result:
```{r echo=FALSE}
local({
  RES <- d.1$evaluatePathways()
  names(RES) <- c('Choice', 'Pathway', 'Probability', 'Cost', 'Utility',
                  'Expected Cost', 'Expected Utility')
  keep <- c('Choice', 'Pathway', 'Probability', 'Cost', 'Expected Cost',
            'Utility', 'Expected Utility')
  knitr::kable(RES[,keep], row.names=F, digits=c(NA,NA,3,2,2,2,5))
})
```

There are, as expected, eight root-to-leaf pathways. The total probability, expected
cost and expected utility for each choice can be calculated from the table above, or
by invoking the `evaluateChoices` method of a decision node. This 
gives the following result, consistent with that reported by
Evans *et al* [-@evans:1997a].

```{r echo=F}
local({
  SUM <- d.1$evaluateChoices()
  names(SUM) <- c('Run', 'Choice', 'Expected Cost', 'Expected Utility')
  keep <- c('Choice', 'Expected Cost', 'Expected Utility')
  knitr::kable(SUM[,keep], row.names=F, digits=c(NA,2,5))
})
```


# References

---
title: "Example Markov Model By Sonnenberg and Beck"
subtitle: "Monte-Carlo / Discrete Event Simulation"
author: "Andrew J. Sims"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Example Markov Model By Sonnenberg and Beck}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
references:
- id: sonnenberg:1993a
  type: article
  title: "Markov Models in Medical Decision Making: A Practical Guide"
  author:
    - family: Sonnenberg
      given: Frank A.
    - family: Beck
      given: J. Robert
  container-title: Medical Decision Making
  issued:
    - year: 1993
  volume: '13'
  page: 322-339
  DOI: 10.1177/0272989X9301300409
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=F}
library(rdecision)
```

# Introduction
The vignette is an example of solving a three-state Markov model using
a Monte-Carlo, or discrete event simulation, approach. The example is 
provided by Sonnenberg and Beck [-@sonnenberg:1993a] in their Figure 3
and Table 1. 

# Model construction
The model is designed with a data frame, `states`, describing the 
three states, the initial prevalance in each state, and the transition
matrix (`incidence`). There are no time-limited states and that matrix
is filled with zeros.
```{r echo=T}
# model parameters
nStates <- 3
state <- data.frame(
  name = c("Well", "Disabled", "Dead"),
  hasCycleLimit = c(FALSE, FALSE, FALSE),
  cycleLimit = c(NA, NA, NA),
  annualCost = c(0, 0, 0),
  entryCost = c(0, 0, 0),
  utility = c(1.0, 0.7, 0.0),
  group = c(0,0,0)
)
prevalence <- c(1.0, 0.0, 0.0)
incidence <- matrix(c(c(NA,  0.2, 0.2),
                      c(0.0,  NA, 0.4),
                      c(0.0, 0.0,  NA)),
                    nrow=nStates, byrow=TRUE
)
Tp <- matrix(rep(0, nStates*nStates), nrow=nStates, byrow=TRUE)
discount <- 0.0
```

The parameters of the simulation are defined as follows, to replicate the
results of Sonneberg and Beck [-@sonnenberg:1993a, Table 2].
```{r echo=T}
# simulation parameters
nPatients <- 10000
nCyclesPerYear <- 1
nYears <- 24
nCycles <- nYears*nCyclesPerYear
```

# Running the model
The following call runs the model for 24 cycles (24 years).
```{r echo=T}
# solve the model using Monte-Carlo method...
ms <- des(nStates=nStates, 
          nGroups = 0,
          nPatients = nPatients,
          nCyclesPerYear = nCyclesPerYear, 
          nCycles = nCycles,
          state = state, 
          group = NA,
          prevalence = prevalence, 
          Ip = incidence, 
          Tp = Tp, 
          Gp = NA,
          discount = discount,
          stub=NA)
```

The summary output from the model is in the following table. Note that the
results differ slighly from Sonnenberg and Beck's Table 2, because the
model has been solved using discrete event simulation, and half-cycle
correction has been applied.

```{r echo=F}
# convert cycle matrices to a data frame for display
POP <- as.data.frame(ms[[1]])
CST <- as.data.frame(ms[[2]])
UTL <- as.data.frame(ms[[4]])
DF <- cbind(
  POP,
  'Utility' = UTL$Total
)
knitr::kable(DF)
```

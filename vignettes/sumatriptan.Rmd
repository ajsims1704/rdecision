---
title: "Sumatriptan versus caffeine for migraine"
subtitle: "A decision tree example"
author: "Andrew J. Sims"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Sumatriptan versus caffeine for migraine}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: "references.bib"
csl: "scientific-reports.csl"
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=F}
library(rdecision)
```

# Introduction
This vignette is an example of modelling a decision tree using the `rdecision`
package. It is based on the example given by Briggs [-@briggs:2002a, Box 2.3] 
which itself is based on a decision tree which compared oral Sumatriptan versus
oral caffeine/Ergotamine for migraine [@evans:1997a].

# Creating the model
The following code constructs the decision tree, node by node. In the
formulation used by `rdecision`, each node is a potentially recursive
structure which is allowed to have zero or more child nodes; any child
nodes must have already been declared before their parent node is declared.
This implies that a tree should be constructed from right to left, starting
with leaf nodes which have no children (leaf nodes are synonymous with
pathways in Briggs' terminology, and called 'States' in `rdecision`). The
final node to be constructed is the left-most decision node in the model.

```{r echo=T}
# Time horizon
th <- as.difftime(48, units="hours")

# Model variables
sumatriptan <- 16.10
caffeine <- 1.32
ED <- 63.16
admission <- 1093

# Sumatriptan branch
state.a <- State$new("A", cost=(sumatriptan), utility=1.0, interval=th)
state.b <- State$new("B", cost=(2*sumatriptan), utility=0.9, interval=th)
state.c <- State$new("C", cost=(sumatriptan), utility=-0.3, interval=th)
state.d <- State$new("D", cost=(sumatriptan+ED), utility=0.1, interval=th)
state.e <- State$new("E", cost=(sumatriptan+ED+admission), utility=-0.3, interval=th)

c.8 <- ChanceNode$new(
  p = list(0.998, 0.002),
  children = list(state.d, state.e),
  edgelabels = list("Relief", "Hospitalization"),
  costs = list(0, 0)
)

c.4 <- ChanceNode$new(
  p = list(0.594, 0.406),
  children = list(state.a, state.b),
  edgelabels = list("No recurrence", "Recurrence relieved with 2nd dose"),
  costs = list(0, 0)
)

c.5 <- ChanceNode$new(
  p = list(0.920, 0.080),
  children = list(state.c, c.8),
  edgelabels = list("Endures attack", "ER"),
  costs = list(0, 0)
)

c.2 <- ChanceNode$new(
  p = list(0.558, 0.442),
  children = list(c.4, c.5),
  edgelabels = list("Relief", "No relief"),
  costs = list(0, 0)
)

# Caffeine/Ergotamine branch
state.f <- State$new("F", cost=(caffeine), utility=1.0, interval=th)
state.g <- State$new("G", cost=(2*caffeine), utility=0.9, interval=th)
state.h <- State$new("H", cost=(caffeine), utility=-0.3, interval=th)
state.i <- State$new("I", cost=(caffeine+ED), utility=0.1, interval=th)
state.j <- State$new("J", cost=(caffeine+ED+admission), utility=-0.3, interval=th)

c.9 <- ChanceNode$new(
  p = list(0.998, 0.002),
  children = list(state.i, state.j),
  edgelabels = list("Relief", "Hospitalization"),
  costs = list(0, 0)
)

c.6 <- ChanceNode$new(
  p = list(0.703, 0.297),
  children = list(state.f, state.g),
  edgelabels = list("No recurrence", "Recurrence relieved with 2nd dose"),
  costs = list(0, 0)
)

c.7 <- ChanceNode$new(
  p = list(0.920, 0.080),
  children = list(state.h, c.9),
  edgelabels = list("Endures attack", "ER"),
  costs = list(0, 0)
)

c.3 <- ChanceNode$new(
  p = list(0.379, 0.621),
  children = list(c.6, c.7),
  edgelabels = list("Relief", "No relief"),
  costs = list(0, 0)
)

# decision node
d.1 <- DecisionNode$new(
  children = list(c.2, c.3),
  edgelabels = list("Sumatriptan", "Caffeine/Ergotamine"),
  costs = list(0, 0)
)
```

# Running the model
The method `evaluatePathways` of decision nodes computes
the probability, cost and utility of traversing each root-to-leaf path
in the model. In the Sumatriptan model there are eight such paths, each 
of which begins with the decision node and ends with a leaf node. For example,
pathway A involves a traversal of nodes `d.1`, `c.2`, `c.4` and
`state.a`. 

# Model results
The results of the scenario model, using the code from the previous sections,
yields the following result:
```{r echo=FALSE}
local({
  RES <- d.1$evaluatePathways()
  names(RES) <- c('Choice', 'Pathway', 'Probability', 'Cost', 'Utility',
                  'Expected Cost', 'Expected Utility')
  keep <- c('Choice', 'Pathway', 'Probability', 'Cost', 'Expected Cost',
            'Utility', 'Expected Utility')
  knitr::kable(RES[,keep], row.names=F, digits=c(NA,NA,3,2,2,2,5))
})
```

There are, as expected, eight root-to-leaf pathways. The total probability, expected
cost and expected utility for each choice can be calculated from the table above, or
by invoking the `evaluateChoices` method of a decision node. This 
gives the following result, consistent with that reported by
Evans *et al* [-@evans:1997a].

```{r echo=F}
local({
  SUM <- d.1$evaluateChoices()
  names(SUM) <- c('Run', 'Choice', 'Expected Cost', 'Expected Utility')
  keep <- c('Choice', 'Expected Cost', 'Expected Utility')
  knitr::kable(SUM[,keep], row.names=F, digits=c(NA,2,5))
})
```


# References

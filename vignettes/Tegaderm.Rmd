---
title: "Tegaderm CHG IV Securement Dressing for Central Venous and Arterial Catheter Insertion Sites"
subtitle: "A decision tree example with probabilistic sensitivity analysis"
author: "Andrew J. Sims"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Tegaderm CHG IV Securement Dressing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
references:
- id: briggs:2002a
  type: book
  author:
    - family: Briggs
      given: Andrew
    - family: Claxton
      given: Karl
    - family: Sculpher
      given: Mark
  title: "Decision modelling for health economic evaluation"
  publisher: "Oxford University Press"
  publisher-place: "Oxford, UK"
  isbn: 978-0-19-852662-9
  issued:
    - year: 2006
- id: jenks:2016a
  type: article
  author:
    - given: Michelle
      family: Jenks
    - given: Joyce
      family: Craig
    - given: William
      family: Green
    - given: Neil
      family: Hewitt
    - given: Mick
      family: Arber
    - given: Andrew J.
      family: Sims
  title: "Tegaderm CHG IV Securement Dressing for Central Venous and Arterial
          Catheter Insertion Sites: A NICE Medical Technology Guidance"
  container-title: "Applied Health Economics and Health Policy"
  issued:
    - year: 2016
  volume: "14"
  page: 135-149
---
```{r, include = FALSE}
rm(list=ls())
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=F}
#library('rdecision')
source("../tools/rdecision-dev.R")
```

# Introduction
This vignette is an example of modelling a decision tree using the `rdecision`
package, with probabilistic sensitivity analysis. It is based on the model reported
by Jenks *et al* [-@jenks:2016a] in which a transparent dressing used to secure
vascular catheters (Tegaderm CHG) was compared with a standard dressing.

Two methods of evaluating the decision are presented. The first method constructs
a decision tree and evaluates the costs associated with traversing each pathway
through it. The second method is a direct calculation and summation of costs,
without the need to construct a tree. Point estimates and probabilistic 
sensitivity analysis are conducted for both methods.

# Model variables
Thirteen variables were used in the model. The choice of
variables, their distributions and their parameters are taken from table 3 
of Jenks *et al* [-@jenks:2016a], with the following corrections:

* For variables with lognormal uncertainty, the manufacturer gave values for the
  mean $m$ and standard deviation $s$ in log space. However, their standard deviations
  were quoted as negative values. This was an error, but had no effect on their results,
  because they sampled values of $\exp(m + sz)$, where $z$ is a sample from a standard 
  normal distribution and is symmetrical about 0. For the variables with
  log normal uncertainty given below, positive standard deviation parameters, with
  the same absolute value, have been used as hyperparameters of the log normal 
  distributions. Also note that the *median* value on the natural scale of a random 
  variable distributed as $logN(m,s)$, where $\mu$ and $\sigma$ are the mean and 
  standard deviation on the log scale, is $e^\mu$; the mean on the natural scale
  is slightly larger. For example, the hazard ratio for CRBSI with Tegaderm versus
  standard dressing was modelled as $logN(-0.911,0.393)$, which has median 0.402
  (the point estimate of the ratio from the literature) and mean 0.434.
* The relative risk for dermatitis was modelled as $logN(1.482,0.490)$.
* The point estimate cost of CRBSI was £9900, not £9990, although the parameters
  (198,50) are quoted correctly.

The 13 model variables were constructed as follows:

```{r variables, echo=T}
# clinical variables
r.CRBSI <- NormalModelVariable$new(
  'Baseline CRBSI rate', '/1000 catheter days', mu=1.48, sigma=0.074
)
hr.CRBSI <- LogNormalModelVariable$new(
  'Tegaderm CRBSI HR', 'ratio', p1=-0.911, p2=0.393
)
r.LSI <- NormalModelVariable$new(
  'Baseline LSI rate', '/patient', mu=0.1, sigma=0.01
)
hr.LSI <- LogNormalModelVariable$new(
  'Tegaderm LSI HR', 'ratio', p1=-0.911, p2=0.393
)
r.Dermatitis <- NormalModelVariable$new(
  'Baseline dermatitis risk', '/catheter', 
  mu=0.0026, sigma=0.00026
)
rr.Dermatitis <- LogNormalModelVariable$new(
  'Tegaderm Dermatitis RR', 'ratio',  p1=1.482, p2=0.490
)

# cost variables
c.CRBSI <- GammaModelVariable$new(
  'CRBSI cost', 'GBP', alpha=198.0, beta=50
)
c.Dermatitis <- GammaModelVariable$new(
  'Dermatitis cost', 'GBP', alpha=30, beta=5
)
c.LSI <- GammaModelVariable$new(
  'LSI cost', 'GBP', alpha=50, beta=5
)
c.Tegaderm <- ConstModelVariable$new(
  'Tegaderm CHG cost', 'GBP', const=6.21
)
c.Standard <- ConstModelVariable$new(
  'Standard dressing cost', 'GBP', const=1.34
)
n.cathdays <- NormalModelVariable$new(
  'No. days with catheter', 'days', mu=10, sigma=2
)
n.dressings <- NormalModelVariable$new(
  'No. dressings', 'dressings', mu=3, sigma=0.3
)
```

# The decision tree approach
The decision problem may be solved by constructing a decision tree
comprising decision nodes, chance nodes and leaf nodes. The general approach is to
create expressions involving model variables, construct a tree,
and then evaluate the decision for the base case and its uncertainty.

## Model variable expressions
Variables in the model may be included in the decision tree via mathematical 
expressions, which involve model variables and are themselves
model variables. Forms of expression involving R's numerical functions and
multiple model variables are supported, provided they conform to R syntax.
The following code creates the model variable expressions to be used as values in the
decision tree nodes.

```{r expressions, echo=TRUE}
# probabilities
p.Dermatitis.S <- ExpressionModelVariable$new(
  'P(dermatitis|standard dressing)', 'P', 
  quote(n.dressings*r.Dermatitis)
)
p.Dermatitis.T <- ExpressionModelVariable$new(
  'P(dermatitis|Tegaderm)', 'P',
  quote(n.dressings*r.Dermatitis*rr.Dermatitis)
)
r.LSI.T <- ExpressionModelVariable$new(
  'P(LSI|Tegaderm)', 'P',
 quote(r.LSI*hr.LSI)
)
p.CRBSI.S <- ExpressionModelVariable$new(
  'P(CRBSI|standard dressing)', 'P',
  quote(r.CRBSI*n.cathdays/1000)
)
p.CRBSI.T <- ExpressionModelVariable$new(
  'P(CRBSI|Tegaderm)', 'P', 
  quote(r.CRBSI*n.cathdays*hr.CRBSI/1000)
)

# costs
c.S <- ExpressionModelVariable$new(
  'Cost of standard dressing', 'GBP',
  quote(n.dressings*c.Standard)
)
c.T <- ExpressionModelVariable$new(
  'Cost of Tegaderm', 'GBP',
  quote(n.dressings*c.Tegaderm)
)
```

## The decision tree
The following code constructs the decision tree, node by node, based on figure 2
of Jenks *et al* [-@jenks:2016a]. In the
formulation used by `rdecision`, each node is a potentially recursive
structure which is allowed to have zero or more child nodes; any child
nodes must have already been declared before their parent node is declared.
This implies that a tree should be constructed from right to left, starting
with leaf nodes which have no children (leaf nodes are synonymous with
pathways in Briggs' terminology [-@briggs:2002a]). The final node to be constructed 
is the node representing the decision problem.

```{r tree, echo=T}
# standard dressing branch
leaf.S.Dermatitis <- LeafNode$new('Dermatitis (Standard Dressing)')
leaf.S.LSI <- LeafNode$new('Local site infection (Standard Dressing)')
leaf.S.CRBSI <- LeafNode$new('CRBSI (Standard Dressing)')
leaf.S.NoComp <- LeafNode$new('No complication (Standard Dressing)')

chance.S <- ChanceNode$new(
  children = list(leaf.S.Dermatitis, leaf.S.LSI, leaf.S.CRBSI, leaf.S.NoComp),
  edgelabels = c('Dermatitis', 'Local site infection', 'CRBSI', 'No complication'),
  costs = list(c.Dermatitis, c.LSI, c.CRBSI, 0),
  p = list(p.Dermatitis.S, r.LSI, p.CRBSI.S, NA)
)

# Tegaderm dressing branch
leaf.T.Dermatitis <- LeafNode$new('Dermatitis (Tegaderm CHG)')
leaf.T.LSI <- LeafNode$new('Local site infection (Tegaderm CHG)')
leaf.T.CRBSI <- LeafNode$new('CRBSI (Tegaderm CHG)')
leaf.T.NoComp <- LeafNode$new('No complication (Tegaderm CHG)')

chance.T <- ChanceNode$new(
  children = list(leaf.T.Dermatitis, leaf.T.LSI, leaf.T.CRBSI, leaf.T.NoComp),
  edgelabels = c('Dermatitis', 'Local site infection', 'CRBSI', 'No complication'),
  costs = list(c.Dermatitis, c.LSI, c.CRBSI, 0),
  p = list(p.Dermatitis.T, r.LSI.T, p.CRBSI.T, NA)
)

# decision node
d <- DecisionNode$new(
  children = list(chance.S, chance.T),
  edgelabels = c('Standard', 'Tegaderm'),
  costs = list(c.S, c.T)
)
```
In the manufacturer's model, the uncertainties in the probabilities associated
with the polytomous chance nodes were modelled as independent variables. This is
not recommended because there is a chance that a particular run of the PSA will
yield probabilities that are outside the range [0,1]. Representing the 
uncertain probabilities with draws from a Dirichlet distribution is preferred. Creating
a `ChanceNode` with ModelVariables is permitted, but results
in a warning being issued.

## Summary of the model
The model variables and their operands associated with a node and (optionally)
its descendants
can be tabulated using the method `tabulateModelVariables`. This returns a data
frame describing each variable, its description, units and uncertainty
distribution. Variables inheriting from type `ModelVariable` will be included in the
tabulation; regular numeric values will not be listed. For extensive models, variables
associated with separate branches of a tree can be tabulated separately by calling
the method for different head nodes. 

The operands of model variables which are 
expressions of other model variables can be included in the tabulation via the
`include.operands` parameter. This is recursive, allowing the complete structure
of a model, *i.e.* its model variables and the way in which they are combined, 
to be tabulated. In the Tegaderm model, the complete structure is as follows:

```{r modelinputs-structure, echo=FALSE}
local({
  DF <- d$tabulateModelVariables(include.descendants=T, include.operands=T)
  keep <- c('Description', 'Label', 'Distribution')
  knitr::kable(DF[,keep], row.names=F, format.args=list(scientific=F), digits=3)
})
```

## Point estimates and distributions of model variables
The point estimates, units and distributional properties are obtained from the
same call, in the remaining columns. Rows with `Qhat` indicate that the 
quantiles have been estimated from simulation.

```{r modelinputs-pe, echo=FALSE}
local({
  DF <- d$tabulateModelVariables(include.descendants=T, include.operands=T)
  keep <- c('Description', 'Units', 'Mean', 'Q2.5', 'Q97.5', 'Qhat')
  knitr::kable(DF[,keep], row.names=F, format.args=list(scientific=F), digits=3)
})
```

## Running the model
The following code runs a single model scenario, using the `evaluatePathways`
method of a decision node to evaluate each pathway from the decision node. In 
the model there are eight possible root-to-leaf paths, each of which
begins with the decision node and ends with a leaf node. For example,
pathway `Dermatitis (Standard Dressing)` involves a traversal of nodes
`d`, `chance.S`, and `leaf.S.Dermatitis`. The method `evaluateChoices`
is similar, but aggregates the results by choice. The results of the scenario
model, using the code from the previous section,
yields the following table. This model did not consider utility, and the
columns associated with utility are removed.

```{r basecase, echo=FALSE}
local({
  RES <- d$evaluatePathways(expected=T)
  keep <- c('Choice', 'Pathway', 'Probability', 'Cost', 'ExpectedCost')
  knitr::kable(RES[,keep], digits=c(NA, NA, 4, 2, 2))
})
```

## Model results

### Base case
```{r basecase-summary, echo=FALSE}
PE.saving <- 0
local({
  SUM <- d$evaluateChoices(expected=T)
  PE.saving <<- SUM$Cost[SUM$Choice=='Tegaderm'] - 
                SUM$Cost[SUM$Choice=='Standard']
})
```
The total cost for each choice can be calculated from the table above, or by calling
`evaluateChoices`, giving a point estimate of the saving of `r round(-1*PE.saving,2)`
GBP. This is close to the sponsor's point 
estimate of cost saving estimated from their probabilistic sensitivity analysis,
77.26 GBP, reported in Jenks *et al* [-@jenks:2016a].

### Probabilistic senstivity analysis
When they are created, each `ModelVariable` returns its expected value when its
method `value()` is called. Calling the method `sample()` of a model variable causes
it to sample from its uncertainty distribution, and return the sampled value when
method `value()` is next called. The same sampled value will be returned until
`sample()` is called again. Calling `sample(expected=T)` causes `value()` to 
return the expected value of the variable. 

Probabilistic sensitivity analysis
is supported through the use of sampling model variables. In practice, because the
model variables enter the model via nodes, the methods `evaluatePathways` and
`evaluateChoices` provided by decision nodes provide a convenient interface for
sampling from model variables. These methods, called with `expected=FALSE` cause
each model variable associated with the decision node and its descendants to be
sampled. For further convenience the method `evaluateChoices` permits replicates
to be run (parameter `N`), making PSA straightforward. The first few runs of
PSA are as follows:

```{r PSA, echo=FALSE}
local({
  PSA <- d$evaluateChoices(expected=F, uncorrelate=F, N=1000)
  RES <<- reshape(PSA, idvar='Run', timevar='Choice', direction='wide')
  RES$Difference <<- RES$Cost.Tegaderm - RES$Cost.Standard
  keep<- c('Run', 'Cost.Tegaderm', 'Cost.Standard', 'Difference')
  knitr::kable(head(RES[,keep], n=10), digits=2, row.names=F)
})
```

From PSA (1000 runs), the mean cost of treatment with Tegaderm 
was `r round(mean(RES$Cost.Tegaderm),2)`,
the mean cost of treatment with standard dressings was `r round(mean(RES$Cost.Standard),2)`
and the mean cost saving was `r round(mean(RES$Difference),2)`. The 95% confidence 
interval for cost saving was `r round(quantile(RES$Difference, probs=c(0.025)),2)` to 
`r round(quantile(RES$Difference, probs=c(0.975)),2)`; the standard deviation of the
cost saving was `r round(sd(RES$Difference),2)`.
Overall, `r round(100*sum(RES$Difference<0)/nrow(RES),2)`% of runs found that Tegaderm
was cost saving. These results replicate those reported by the manufucturer (saving
of 77.26, 98.5% cases cost saving).

```{r echo=F}
rm(RES)
```

# An alternative, tree-free approach
It is possible to solve the decision problem without first constructing a tree, by
combining model variables directly. This is, in essence, the approach taken in
many decision tree models constructed in Excel. 

## Components of cost
Each cost component is defined as an expression involving two or more
of the 13 model inputs. In contrast to the tree approach, which computed
the cost of traversing each pathway, this approach allows the costs of the
technology and its comparator to be constructed as sub-totals.
```{r treefree, echo=TRUE}
# component costs, standard dressing
CHG.S <- ExpressionModelVariable$new(
  "Cost of standard dressing", "GBP", 
  quote(n.dressings*c.Standard)
)
CRBSI.S <- ExpressionModelVariable$new(
  "Cost of CRBSI, standard dressing", "GBP", 
  quote(c.CRBSI*r.CRBSI*n.cathdays/1000)
)
LSI.S <- ExpressionModelVariable$new(
  "Cost of LSI, standard dressing", "GBP", 
  quote(c.LSI*r.LSI)
)
Dermatitis.S <- ExpressionModelVariable$new(
  "Cost of dermatitis, standard dressing", "GBP",
  quote(r.Dermatitis*c.Dermatitis*n.dressings)
)

# component costs, Tegaderm
CHG.T <- ExpressionModelVariable$new(
  "Cost of Tegaderm", "GBP", 
  quote(n.dressings*c.Tegaderm)
)
CRBSI.T <- ExpressionModelVariable$new(
  "Cost of CRBSI, Tegaderm", "GBP", 
  quote(c.CRBSI*r.CRBSI*hr.CRBSI*n.cathdays/1000)
)
LSI.T <- ExpressionModelVariable$new(
  "Cost of LSI, Tegaderm", "GBP", 
  quote(c.LSI*r.LSI*hr.LSI)
)
Dermatitis.T <- ExpressionModelVariable$new(
  "Cost of dermatitis, Tegaderm", "GBP",
  quote(r.Dermatitis*c.Dermatitis*rr.Dermatitis*n.dressings)
)

# per-patient costs
total.T <- ExpressionModelVariable$new(
  'Treatment cost (Tegaderm)', 'GBP',
  quote(CHG.T+CRBSI.T+LSI.T+Dermatitis.T)
)
total.S <- ExpressionModelVariable$new(
  'Treatment cost (Standard)', 'GBP',
  quote(CHG.S+CRBSI.S+LSI.S+Dermatitis.S)
)
c.diff <- ExpressionModelVariable$new(
  'Cost difference', 'GBP',
  quote(total.T-total.S)
)
```

## Base case
The components of cost can be extracted by tabulating the model variables
in the cost difference model variable, `c.diff` via method `tabulate`. In this
case, only the rows containing component costs are displayed.
```{r treefree-base, echo=FALSE}
local({
  MV <- c.diff$tabulate(include.operands=TRUE)
  vars <- c('CHG.S', 'CRBSI.S', 'LSI.S', 'Dermatitis.S',
            'CHG.T', 'CRBSI.T', 'LSI.T', 'Dermatitis.T',
            'total.S', 'total.T', 'c.diff')
  keep <- c('Description', 'Units', 'Mean', 'SD', 'Q2.5', 'Q97.5', 'Qhat')
  knitr::kable(MV[MV$Label %in% vars, keep], row.names=F, 
               format.args=list(scientific=F), digits=2
               )
})
```

The point estimate of saving is obtained directly from the expectation
of the cost difference variable, `r round(-1*c.diff$getMean(),2)`. This
is identical to the value obtained from the full tree. The table also
indicates, by the quantiles of the cost difference, the approximate
confidence interval of the saving.

## Probabilistic sensitivity analysis
```{r echo=FALSE}
tf.psa <- c.diff$r(1000)
```
Each model variable provides a method, `r`, to make random draws from its
uncertainty distribution. The PSA for the cost difference can therefore be 
achieved by a single call to this method. From this, the mean cost saving
was `r round(mean(tf.psa),2)`, the 
95% confidence interval of the saving was `r round(quantile(tf.psa,0.025),2)` 
to `r round(quantile(tf.psa,0.975),2)` 
and `r round(100*sum(tf.psa<0)/length(tf.psa),2)`% of runs generated a cost saving.
Within fluctuation error this is consistent with the manufacturer's reported
saving of 77.26 with 98.5% of runs being cost saving.

# A note on correlation of model variables
Of the 13 input variables defined in the tree model, eight appear in both the
main branches of the decision tree. If, in PSA, common variables are sampled
from their uncertainty distributions once per run, rather being sampled for 
each choice within a run, the costs of each arm will be correlated.

```{r CORR, echo=FALSE}
local({
  PSA <- d$evaluateChoices(expected=F, uncorrelate=F, N=1000)
  RES.C <<- reshape(PSA, idvar='Run', timevar='Choice', direction='wide')
  RES.C$Difference <<- RES.C$Cost.Tegaderm - RES.C$Cost.Standard
  R.C <<- cor(RES.C$Cost.Tegaderm, RES.C$Cost.Standard)

  PSA <- d$evaluateChoices(expected=F, uncorrelate=T, N=1000)
  RES.U <<- reshape(PSA, idvar='Run', timevar='Choice', direction='wide')
  RES.U$Difference <<- RES.U$Cost.Tegaderm - RES.U$Cost.Standard
  R.U <<- cor(RES.U$Cost.Tegaderm, RES.U$Cost.Standard)
  
  sd.T <<- sd(RES.C$Cost.Tegaderm)
  sd.S <<- sd(RES.C$Cost.Standard)
  cov.TS <<- cov(RES.C$Cost.Tegaderm, RES.C$Cost.Standard)  
})
```

In the original Excel model submitted by the manufacturer, the model variables
were sampled once per run. The tree model constructed using `rdecision` described
in this vignette made the same assumption, and replicated the manufacturer's
results. The correlation coefficient between 1000 samples from the cost of 
treatment with Tegaderm and the cost with standard care was `r round(R.C, 3)`. This
reflects the relatively high degree of correlation between the two choice
arms of the model, because of the eight shared model variables.

However, `rdecision` includes the facility to resample the model
variables for each choice, within each run, by setting parameter
`uncorrelate=TRUE` in method `evaluateChoices` of a decision node.
With this option, the equivalent correlation coefficient is `r round(R.U, 3)`;
*i.e.* they are uncorrelated within statistical fluctuation. This does not
affect the point estimate, but does alter the distribution of the
cost difference, which has standard deviation `r round(sd(RES.U$Difference),2)`
and 95% confidence interval `r round(quantile(RES.U$Difference, probs=c(0.025)),2)` 
to `r round(quantile(RES.U$Difference, probs=c(0.975)),2)`, 
with `r round(100*sum(RES.U<0)/nrow(RES.U),1)`% of simulations being
cost saving.
The confidence interval includes zero, but the percentage of
cost saving cases exceeds 95%; with correlation removed, the evidence
for a cost saving is therefore marginal, given the input parameters.

Finally, the variance of the cost of treatment with Tegaderm 
is `r round(sd.T,2)`$^2$, the variance of the cost of treatment with
standard care is `r round(sd.S,2)`$^2$ and the covariance with
correlated model variables is `r round(cov.TS,2)`. Via the relation
$Var(X-Y) = Var(X) + Var(Y) - 2Cov(X,Y)$, the variance of the
cost difference with correlated model variables 
is `r round(sqrt(sd.T^2 + sd.S^2 - 2*cov.TS),2)`$^2$ and with the
uncorrelated model variables 
is `r round(sqrt(sd.T^2 + sd.S^2),2)`$^2$, close to the observed values.

```{r CORREND, echo=FALSE}
rm(RES.C, RES.U, R.C, R.U, sd.T, sd.S, cov.TS)
```


# References

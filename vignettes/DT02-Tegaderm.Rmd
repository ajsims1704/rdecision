---
title: "Tegaderm CHG IV Securement Dressing for Central Venous and Arterial Catheter Insertion Sites"
subtitle: "A decision tree example with probabilistic sensitivity analysis"
author: "Andrew J. Sims"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Tegaderm CHG IV Securement Dressing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: "references.bib"
csl: "bmj.csl"
---
```{r, include = FALSE}
rm(list=ls())
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE, echo=FALSE}
library("rdecision")
library("rlang")
library("pander")
```

# Introduction
This vignette is an example of modelling a decision tree using the `rdecision`
package, with probabilistic sensitivity analysis. It is based on the model reported
by Jenks *et al* [-@jenks:2016a] in which a transparent dressing used to secure
vascular catheters (Tegaderm CHG) was compared with a standard dressing.

Two methods of evaluating the decision are presented. The first method constructs
a decision tree and evaluates the costs associated with traversing each pathway
through it. The second method is a direct calculation and summation of costs,
without the need to construct a tree. Point estimates and probabilistic 
sensitivity analysis are conducted for both methods.

# Model variables
Thirteen variables were used in the model. The choice of
variables, their distributions and their parameters are taken from table 3 
of Jenks *et al* [-@jenks:2016a], with the following corrections:

* For variables with lognormal uncertainty, the manufacturer gave values for the
  mean $m$ and standard deviation $s$ in log space. However, their standard deviations
  were quoted as negative values. This was an error, but had no effect on their results,
  because they sampled values of $\exp(m + sz)$, where $z$ is a sample from a standard 
  normal distribution and is symmetrical about 0. For the variables with
  log normal uncertainty given below, positive standard deviation parameters, with
  the same absolute value, have been used as hyperparameters of the log normal 
  distributions. Also note that the *median* value on the natural scale of a random 
  variable distributed as $logN(m,s)$, where $\mu$ and $\sigma$ are the mean and 
  standard deviation on the log scale, is $e^\mu$; the mean on the natural scale
  is slightly larger. For example, the hazard ratio for CRBSI with Tegaderm versus
  standard dressing was modelled as $logN(-0.911,0.393)$, which has median 0.402
  (the point estimate of the ratio from the literature) and mean 0.434.
* The relative risk for dermatitis was modelled as $logN(1.482,0.490)$.
* The point estimate cost of CRBSI was £9900, not £9990, although the parameters
  (198,50) are quoted correctly.

The 13 model variables were constructed as follows:

```{r variables, echo=T}
# clinical variables
r.CRBSI <- NormModVar$new(
  'Baseline CRBSI rate', '/1000 catheter days', mu=1.48, sigma=0.074
)
hr.CRBSI <- LogNormModVar$new(
  "Tegaderm CRBSI HR", 'ratio', p1=-1.009, p2=0.443
)
r.LSI <- NormModVar$new(
  'Baseline LSI rate', '/patient', mu=0.1, sigma=0.01
)
hr.LSI <- LogNormModVar$new(
  "Tegaderm LSI HR", "ratio", p1=-1.009, p2=0.443
)
r.Dermatitis <- NormModVar$new(
  'Baseline dermatitis risk', '/catheter', mu=0.0026, sigma=0.00026
)
rr.Dermatitis <- LogNormModVar$new(
  'Tegaderm Dermatitis RR', 'ratio',  p1=1.383, p2=0.443
)

# cost variables
c.CRBSI <- GammaModVar$new(
  'CRBSI cost', 'GBP', shape=198.0, scale=50
)
c.Dermatitis <- GammaModVar$new(
  'Dermatitis cost', 'GBP', shape=30, scale=5
)
c.LSI <- GammaModVar$new(
    'LSI cost', 'GBP', shape=50, scale=5
  )
c.Tegaderm <- ConstModVar$new(
  'Tegaderm CHG cost', 'GBP', const=6.21
)
c.Standard <- ConstModVar$new(
  'Standard dressing cost', 'GBP', const=1.34
)
n.cathdays <- NormModVar$new(
  'No. days with catheter', 'days', mu=10, sigma=2
)
n.dressings <- NormModVar$new(
  'No. dressings', 'dressings', mu=3, sigma=0.3
)
```

The lognormal parameters for variables `hr.CRBSI` and `hr.LSI` differ from those
provided in Table 3 of Jenks *et al*, which were asumed to be in error because
the $\alpha$ and $\beta$ coefficients provided do not give rise to the quoted
mean value or confidence intervals for any known parametrization of the log
normal distribtion, and were estimated - for this vignette - by fitting to 
the required mean and 95% CI as closely as possible.

# The decision tree approach
The decision problem may be solved by constructing a decision tree
comprising decision nodes, chance nodes and leaf nodes. The general approach is to
create expressions involving model variables, construct a tree,
and then evaluate the decision for the base case and its uncertainty.

## Model variable expressions
Variables in the model may be included in the decision tree via mathematical 
expressions, which involve model variables and are themselves
model variables. Forms of expression involving R's numerical functions and
multiple model variables are supported, provided they conform to R syntax.
The following code creates the model variable expressions to be used as values in the
decision tree edges.

```{r expressions, echo=TRUE}
# probabilities
p.Dermatitis.S <- ExprModVar$new(
  'P(dermatitis|standard dressing)', 'P', 
  rlang::quo(n.dressings*r.Dermatitis)
)
p.Dermatitis.T <- ExprModVar$new(
  'P(dermatitis|Tegaderm)', 'P', 
  rlang::quo(n.dressings*r.Dermatitis*rr.Dermatitis)
)
r.LSI.T <- ExprModVar$new(
  'P(LSI|Tegaderm)', 'P', rlang::quo(r.LSI*hr.LSI)
)
p.CRBSI.S <- ExprModVar$new(
  'P(CRBSI|standard dressing)', 'P',  rlang::quo(r.CRBSI*n.cathdays/1000)
)
p.CRBSI.T <- ExprModVar$new(
  'P(CRBSI|Tegaderm)', 'P', rlang::quo(r.CRBSI*n.cathdays*hr.CRBSI/1000)
)
p.NoComp.S <- ExprModVar$new("P(No comp|standard dressing)", "P",
  rlang::quo(1-(p.Dermatitis.S+r.LSI+p.CRBSI.S))
)
p.NoComp.T <- ExprModVar$new("P(No comp|Tegaderm)", "P",
  rlang::quo(1-(p.Dermatitis.T+r.LSI.T+p.CRBSI.T))
)

```

## The decision tree
The following code constructs the decision tree based on figure 2
of Jenks *et al* [-@jenks:2016a]. In the formulation used by `rdecision`, 
the decision tree is constructed from sets of decision, chance and 
leaf nodes and from edges (actions and reactions).
Leaf nodes are synonymous with
pathways in Briggs' terminology [-@briggs:2002a]). The time horizon is
not stated explicitly in the model, and is assumed to be 7 days here. It was implied
that the time horizon was ICU stay plus some follow-up, and the costs reflect
those incurred in that period, so the assumption of 7 days does not affect
the `rdecision` implementation of the model.

```{r tree, echo=T}
# create decision tree
th <- as.difftime(7, units="days")
# standard dressing branch
t1 <- LeafNode$new("Dermatitis", interval=th)
t2 <- LeafNode$new("LSI", interval=th)
t3 <- LeafNode$new("CRBSI", interval=th)
t4 <- LeafNode$new("No comp", interval=th)
c1 <- ChanceNode$new()
e1 <- Reaction$new(c1,t1,p=p.Dermatitis.S,cost=c.Dermatitis)
e2 <- Reaction$new(c1,t2,p=r.LSI,cost=c.LSI)
e3 <- Reaction$new(c1,t3,p=p.CRBSI.S,cost=c.CRBSI)
e4 <- Reaction$new(c1,t4,p=p.NoComp.S,cost=0)
# Tegaderm dressing branch
t5 <- LeafNode$new("Dermatitis", interval=th)
t6 <- LeafNode$new("LSI", interval=th)
t7 <- LeafNode$new("CRBSI", interval=th)
t8 <- LeafNode$new("No comp", interval=th)
c2 <- ChanceNode$new()
e5 <- Reaction$new(c2,t5,p=p.Dermatitis.T,cost=c.Dermatitis)
e6 <- Reaction$new(c2,t6,p=r.LSI.T,cost=c.LSI)
e7 <- Reaction$new(c2,t7,p=p.CRBSI.T,cost=c.CRBSI)
e8 <- Reaction$new(c2,t8,p=p.NoComp.T,cost=0)
# decision node
d1 <- DecisionNode$new("d1")
e9 <- Action$new(d1,c1,label="Standard",cost=c.Standard)
e10 <- Action$new(d1,c2,label="Tegaderm",cost=c.Tegaderm)
# create decision tree
V <- list(d1,c1,c2,t1,t2,t3,t4,t5,t6,t7,t8)
E <- list(e1,e2,e3,e4,e5,e6,e7,e8,e9,e10)
DT <- DecisionTree$new(V,E)
```
In the manufacturer's model, the uncertainties in the probabilities associated
with the polytomous chance nodes were modelled as independent variables. This is
not recommended because there is a chance that a particular run of the PSA will
yield probabilities that are outside the range [0,1]. Representing the 
uncertain probabilities with draws from a Dirichlet distribution is preferred. Creating
a `ChanceNode` with ModVars is permitted, but results
in a warning being issued.

## Summary of the model
The model variables and their operands associated with a node and (optionally)
its descendants
can be tabulated using the method `tabulate_modvars`. This returns a data
frame describing each variable, its description, units and uncertainty
distribution. Variables inheriting from type `ModVar` will be included in the
tabulation; regular numeric values will not be listed. For extensive models, variables
associated with separate branches of a tree can be tabulated separately by calling
the method for different head nodes. 

The operands of model variables which are 
expressions of other model variables can be included in the tabulation via the
`include.operands` parameter. This is recursive, allowing the complete structure
of a model, *i.e.* its model variables and the way in which they are combined, 
to be tabulated. In the Tegaderm model, the complete structure is as follows:

```{r modelinputs-structure, echo=FALSE}
local({
  DF <- DT$modvar_table()
  keep <- c("Description", "Distribution")
  pander::pander(DF[,keep], row.names=F, digits=3, justify="left")
})
```

## Point estimates and distributions of model variables
The point estimates, units and distributional properties are obtained from the
same call, in the remaining columns. Rows with `Qhat` indicate that the 
quantiles have been estimated from simulation.

```{r modelinputs-pe, echo=FALSE}
local({
  DF <- DT$modvar_table()
  keep <- c("Description", "Units", "Mean", "Q2.5", "Q97.5")
  pander::pander(DF[,keep], row.names=F, digits=3, justify="left")
})
```

## Running the model
The following code runs a single model scenario, using the `evaluatePathways`
method of a decision node to evaluate each pathway from the decision node. In 
the model there are eight possible root-to-leaf paths, each of which
begins with the decision node and ends with a leaf node. For example,
pathway `Dermatitis (Standard Dressing)` involves a traversal of nodes
`d`, `chance.S`, and `leaf.S.Dermatitis`. The method `evaluateChoices`
is similar, but aggregates the results by choice. The results of the scenario
model, using the code from the previous section,
yields the following table. This model did not consider utility, and the
columns associated with utility are removed.

```{r basecase, echo=FALSE}
#local({
#  RES <- DT$evaluate(expected=T)
#  keep <- c('Choice', 'Pathway', 'Probability', 'Cost', 'ExpectedCost')
#  knitr::kable(RES[,keep], digits=c(NA, NA, 4, 2, 2))
#})
```


# References

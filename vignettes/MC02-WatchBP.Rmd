---
title: "Markov Model with transition costs (Willits 2012)"
subtitle: "Cost impact of the WatchBP Home A used in primary healthcare"
author: "Andrew J. Sims"
date: "May 2021"
output: 
  rmarkdown::html_vignette:
    fig_width: 7
    fig_height: 5
    fig_caption: true
vignette: >
  %\VignetteIndexEntry{Markov Model with transition costs (Willits 2012)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: "../inst/REFERENCES.bib"
csl: "../inst/national-institute-of-health-research.csl"
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  fig.keep = "last",
  fig.align = "center",
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=F}
library(rdecision)
library(pander)
library(png)
```

# Introduction
This vignette describes a Markov model that was used to evaluate the cost 
consequences of opportunistic screening for atrial fibrillation (AF) during
clinic visits involving blood pressure measurement. It was first developed
for the assessment of the WatchBP oscillometric blood pressure measurement
device by the National Institute of Health and Care Excellence (NICE)
[@willits2014a] and is described fully in a report that was published during
the guidance development process [@willits2012a].

The guidance report followed two cohorts, those aged 65-74 and those aged 
75-84, to account for the age dependency in risk of AF. This vignette
focuses on the older cohort.

# Diagnostic phase
```{r tree-vars, echo=FALSE}
# sens and spec of index and comparator tests
Sn.I <- 0.967
Sp.I <- 0.888
Sn.C <- 0.872
Sp.C <- 0.813
# prevalence
prev <- 0.072
# cohort size
N <- 100000
```
The diagnostic phase was modelled as a decision tree in which the
diagnostic
test accuracies of the index technology (WatchBP) and the comparator technology 
(pulse palpation) were used to estimate the proportions of the cohort falling
into the true positive (TP), true negative (TN), false positive (FP) and false
negative (FN) categories. These proportions were used to define the starting
populations in the management phase (a Markov model) with a cohort size 
of `r N`. In the diagnostic phase the prevalance of AF was `r prev`; WatchBP 
had a sensitivity of `r Sn.I` and a specificity of `r Sp.I`; pulse palpation had 
a sensitivity of `r Sn.C` and a specificity of `r Sp.C`.

```{r tree, echo=FALSE}
# index test branch
TP.I <- LeafNode$new("TP")
FN.I <- LeafNode$new("FN")
cP.I <- ChanceNode$new()
eTP.I <- Reaction$new(cP.I, TP.I, p=Sn.I, label="Test +ve")
eFN.I <- Reaction$new(cP.I, FN.I, p=1-Sn.I, label="Test -ve")
FP.I <- LeafNode$new("FP")
TN.I <- LeafNode$new("TN")
cN.I <- ChanceNode$new()
eFP.I <- Reaction$new(cN.I, FP.I, p=1-Sp.I, label="Test +ve")
eTN.I <- Reaction$new(cN.I, TN.I, p=Sp.I, label="Test -ve")
c.I <- ChanceNode$new()
eP.I <- Reaction$new(c.I, cP.I, p=prev, label="Has AF")
eN.I <- Reaction$new(c.I, cN.I, p=1-prev, label="Does not have AF")
# comparator test branch
TP.C <- LeafNode$new("TP")
FN.C <- LeafNode$new("FN")
cP.C <- ChanceNode$new()
eTP.C <- Reaction$new(cP.C, TP.C, p=Sn.C, label="Test +ve")
eFN.C <- Reaction$new(cP.C, FN.C, p=1-Sn.C, label="Test -ve")
FP.C <- LeafNode$new("FP")
TN.C <- LeafNode$new("TN")
cN.C <- ChanceNode$new()
eFP.C <- Reaction$new(cN.C, FP.C, p=1-Sp.C, label="Test +ve")
eTN.C <- Reaction$new(cN.C, TN.C, p=Sp.C, label="Test -ve")
c.C <- ChanceNode$new()
eP.C <- Reaction$new(c.C, cP.C, p=prev, label="Has AF")
eN.C <- Reaction$new(c.C, cN.C, p=1-prev, label="Does not have AF")
# decision node
d <- DecisionNode$new("Test")
e.I <- Action$new(d,c.I,label="WatchBP")
e.C <- Action$new(d,c.C,label="PP")
# tree
DT <- DecisionTree$new(
  V = list(
    TP.I,FP.I,FN.I,TN.I,cP.I,cN.I,c.I,
    TP.C,FP.C,FN.C,TN.C,cP.C,cN.C,c.C,
    d),
  E = list(
    eTP.I,eFP.I,eFN.I,eTN.I,eP.I,eN.I,e.I,
    eTP.C,eFP.C,eFN.C,eTN.C,eP.C,eN.C,e.C
  )
)
```

The number of patients predicted to be in each of the four categories for each
test is shown in the table below.
```{r tree-calc, echo=FALSE}
DF <- DT$evaluate(by="path")
DF$Population <- DF$Probability*N
keep <- c("Leaf", "Test", "Population")
pander::pander(DF[,keep])
```

# Management phase



# References
